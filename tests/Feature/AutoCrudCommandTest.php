<?php

namespace Tests\Features;

use Mockery;
use Tests\TestCase;
use Illuminate\Support\Str;
use Illuminate\Contracts\Console\Kernel;

class AutoCrudCommandTest extends TestCase
{
    /**
     * The directory holding the migrations for these tests.
     *
     * @var string
     */
    protected $migrations = __DIR__ . '/../migrations';

    /**
     * Assert that the command with the given name is called when we call
     * `autocrud:make`.
     *
     * @param string $name The name of the inner command
     */
    private function assertCommandIsCalled(string $name)
    {
        $kernel = app(Kernel::class);

        $class = get_class($kernel->all()[$name]);

        // Replace the command with a spy, so that we can later assert that its
        // `handle` method has been called once.
        $kernel->registerCommand(
            $command = Mockery::spy($class . '[handle]')
        );

        $this->artisan('autocrud:make');

        $command->shouldHaveReceived('handle')->once();
    }

    /**
     * Assert that the options.
     *
     * @param string $name
     * @param array $makeArguments
     * @param array $expectedOptions
     */
    private function assertOptionsPassedToInner(string $name, array $makeArguments = [], array $expectedOptions = [])
    {
        $makeArguments = ['--table' => ['users']] + $makeArguments;
        $expectedOptions = ['table' => ['users']] + $expectedOptions;

        $command = app(Kernel::class)->all()[$name];

        $this->artisan('autocrud:make', $makeArguments);

        $this->assertArrayHasSubset($expectedOptions, $command->options());
    }

    /**
     * Assert that the expected files were generated.
     */
    private function assertFilesWereGenerated()
    {
        $tablenames = [
            'users',
            'avatars',
            'products',
            'roles',
            'sales',
            'payment_methods',
        ];

        foreach ($tablenames as $tablename) {
            $singular = Str::singular($tablename);
            $model = Str::ucfirst(Str::camel($singular));
            $modelPlural = Str::plural($model);

            $this->assertFileExists(app_path("${model}.php"));

            $this->assertFileExists(app_path("Http/Controllers/${model}Controller.php"));

            $this->assertFileExists(database_path("factories/${model}Factory.php"));

            $this->assertFileExists(app_path("Http/Requests/${model}Request.php"));

            $this->assertFileExists(base_path("tests/Feature/{$modelPlural}CrudTest.php"));

            foreach (['index', 'show', 'create', 'edit'] as $view) {
                $this->assertFileExists(resource_path("views/$tablename/$view.blade.php"));
            }

            $this->assertRouteHas("Route::resource('/$tablename', '${model}Controller');");
        }
    }

    private function assertRouteHas($code)
    {
        $this->assertCodeContains(
            $code,
            $this->files->get(base_path('routes/web.php'))
        );
    }

    /** @test */
    public function it_calls_the_inner_commands()
    {
        $this->assertCommandIsCalled('autocrud:model');
        $this->assertCommandIsCalled('autocrud:controller');
        $this->assertCommandIsCalled('autocrud:factory');
        $this->assertCommandIsCalled('autocrud:seeder');
        $this->assertCommandIsCalled('autocrud:request');
        $this->assertCommandIsCalled('autocrud:route');
        $this->assertCommandIsCalled('autocrud:view');
        $this->assertCommandIsCalled('autocrud:test');
    }

    /** @test */
    public function it_sends_the_correct_options_to_the_inner_commands()
    {
        $this->assertOptionsPassedToInner('autocrud:model', ['--dir' => 'Models'], ['dir' => 'Models']);
        $this->assertOptionsPassedToInner('autocrud:controller', ['--dir' => 'Models'], ['dir' => 'Models']);
        $this->assertOptionsPassedToInner('autocrud:factory', ['--dir' => 'Models'], ['dir' => 'Models']);
        $this->assertOptionsPassedToInner('autocrud:seeder', ['--dir' => 'Models'], ['dir' => 'Models']);
        $this->assertOptionsPassedToInner('autocrud:request', ['--dir' => 'Models'], ['dir' => 'Models']);
        $this->assertOptionsPassedToInner('autocrud:route', ['--skip-api' => true], ['skip-api' => true]);
        $this->assertOptionsPassedToInner('autocrud:view', ['--dir' => 'Models'], ['dir' => 'Models']);
        $this->assertOptionsPassedToInner('autocrud:view', ['--skip-api' => true], []);
        $this->assertOptionsPassedToInner('autocrud:test', ['--dir' => 'Models'], ['dir' => 'Models']);
    }

    /** @test */
    public function it_can_make_crud_files()
    {
        $this->artisan('autocrud:make');

        $this->assertFilesWereGenerated();
    }

    /** @test */
    public function it_fails_on_non_existing_tables()
    {
        $command = $this->artisan('autocrud:make', [
            '--table' => ['non_existing_table'],
        ]);

        $command
            ->expectsOutput('Table non_existing_table does not exist.')
            ->assertExitCode(1);
    }
}
